"break vi compatibility
set nocompatible
"prevent file exploit
set modelines=0

"pathogen
call pathogen#infect()

"detect file type
filetype on
"use specific filetype plugins
filetype plugin on
filetype plugin indent on
" activate matchit
runtime macros/matchit.vim

set title " change terminal/window title to buffer name

"code highlight:
syntax on
"colorscheme:
colorscheme wombat256mod
"font:
set guifont=Anonymice\ Powerline\ for\ Powerline:h14
"airline (remplacement for powerline)
let g:airline_theme='wombat'
let g:airline_powerline_fonts=1
set laststatus=2
set t_Co=256
"display list of opened buffers
let g:airline#extensions#tabline#enabled=1
"display buffer filename only
let g:airline#extensions#tabline#fnamemod=':t'

"leader character:
let mapleader = ","

"navigate through tabs
nmap <C-S-tab> :tabprevious<CR>
nmap <C-tab> :tabnext<CR>

"navigate through splits using arrows
nmap <silent> <S-Up> :wincmd k<CR>
nmap <silent> <S-Down> :wincmd j<CR>
nmap <silent> <S-Left> :wincmd h<CR>
nmap <silent> <S-Right> :wincmd l<CR>

"display side file explorer
let g:netrw_liststyle = 3
let g:netrw_winsize   = 15
let g:netrw_banner = 0
nmap <leader>d :Lex<CR> " This will toggle the file explorer on/off

"indentation
set tabstop=2
set shiftwidth=2
set softtabstop=2
set expandtab
"text layout
set wrap
set textwidth=100
set formatoptions=qrn1
set colorcolumn=100
set autoindent

"case insensitive file completion
set wildignorecase

"show trailing spaces
highlight TrailingSpaces ctermbg=red guibg=red
match TrailingSpaces /\s\+$\|\t/

if has("multi_byte")
  if &termencoding == ""
    let &termencoding = &encoding
  endif
  set encoding=utf-8
  setglobal fileencoding=utf-8
  "setglobal bomb
  set fileencodings=ucs-bom,utf-8,latin1
endif
set scrolloff=3
set showmode
set showcmd "display current command (nice for <leader>)
set hidden
set visualbell
set cursorline
set ttyfast
set ruler
set backspace=indent,eol,start

"vim commands autocompletion
set wildmenu
set wildmode=list:longest,full
set wildignore+=*/tmp/*,*/build*/*,*.o,*.so,*.swp,*.zip,*/vendor/*,*/\.git/*


"search option
set ignorecase
set smartcase
set gdefault
set incsearch
set showmatch
set hlsearch
"clear highlight on 'return':
nnoremap <silent> <CR> :noh<CR>

"manage backup, swap & undo directories
set nobackup
set noswapfile

:silent !mkdir -p /tmp/vim/undo >/dev/null 2>&1
set undodir=/tmp/vim/undo
set undofile
set history=1000     " remember more commands and search history
set undolevels=1000  " use many muchos levels of undo



"json highlight
au BufRead,BufNewFile *.json set filetype=javascript

" no extension filetype
" (from http://stackoverflow.com/questions/2666551/vim-default-syntax-for-files-with-no-extension)
au BufNewFile,BufRead * if &syntax == '' | set filetype=cpp | endif

"python & cpp indentation
autocmd Filetype python setlocal tabstop=4 shiftwidth=4 softtabstop=4
autocmd Filetype cpp    setlocal tabstop=4 shiftwidth=4 softtabstop=4

" from https://github.com/tpope/vim-sensible
if v:version > 703 || v:version == 703 && has("patch541")
  set formatoptions+=j " Delete comment character when joining commented lines
endif

" taglist
nnoremap <leader>t :TlistToggle<CR>
let Tlist_Use_Right_Window = 1

" toggle comment
vnoremap <leader>c :TComment<CR>

:silent !mkdir -p /tmp/vim/cache/unite >/dev/null 2>&1
let g:unite_data_directory='/tmp/vim/cache/unite'
let g:unite_enable_start_insert=1
" search in content
nnoremap <Leader>f :Unite grep:.<cr>
" search files CtrlP search
call unite#filters#matcher_default#use(['matcher_fuzzy'])
call unite#filters#sorter_default#use(['sorter_rank'])
call unite#custom#source('file_rec/async','sorters','sorter_rank')
" replacing unite with ctrl-p
nnoremap <silent> <leader>p :Unite -auto-resize file file_mru file_rec/async<cr>
" from http://sheerun.net/2014/03/21/how-to-boost-your-vim-productivity/
" use git for fast autocomplete
let g:ctrlp_use_caching = 0
let g:ctrlp_user_command = ['.git', 'cd %s && git ls-files . -co --exclude-standard', 'find %s -type f']
let g:ctrlp_prompt_mappings = {
  \ 'AcceptSelection("e")': ['<space>', '<cr>', '<2-LeftMouse>'],
  \ }


" Search for selected text, forwards or backwards.
vnoremap <silent> * :<C-U>
  \let old_reg=getreg('"')<Bar>let old_regtype=getregtype('"')<CR>
  \gvy/<C-R><C-R>=substitute(
  \escape(@", '/\.*$^~['), '\_s\+', '\\_s\\+', 'g')<CR><CR>
  \gV:call setreg('"', old_reg, old_regtype)<CR>
vnoremap <silent> # :<C-U>
  \let old_reg=getreg('"')<Bar>let old_regtype=getregtype('"')<CR>
  \gvy?<C-R><C-R>=substitute(
  \escape(@", '?\.*$^~['), '\_s\+', '\\_s\\+', 'g')<CR><CR>
  \gV:call setreg('"', old_reg, old_regtype)<CR>

function! DoPrettyJSON()
  " save the filetype so we can restore it later
  let l:origft = &ft
  " this requires a python install
  silent %!python -m json.tool
  exe "set ft=" . l:origft
endfunction
command! PrettyJSON call DoPrettyJSON()

function! DoPrettyXML()
  " save the filetype so we can restore it later
  let l:origft = &ft
  set ft=
  " delete the xml header if it exists. This will
  " permit us to surround the document with fake tags
  " without creating invalid xml.
  1s/<?xml .*?>//e
  " insert fake tags around the entire document.
  " This will permit us to pretty-format excerpts of
  " XML that may contain multiple top-level elements.
  0put ='<PrettyXML>'
  $put ='</PrettyXML>'
  silent %!xmllint --format -
  " xmllint will insert an <?xml?> header. it's easy enough to delete
  " if you don't want it.
  " delete the fake tags
  2d
  $d
  " restore the 'normal' indentation, which is one extra level
  " too deep due to the extra tags we wrapped around the document.
  silent %<
  " back to home
  1
  " restore the filetype
  exe "set ft=" . l:origft
endfunction
command! PrettyXML call DoPrettyXML()

" sets clang for C++ with syntastic
set statusline+=%#warningmsg#
set statusline+=%{SyntasticStatuslineFlag()}
set statusline+=%*

let g:syntastic_python_checkers = ['flake8']
let g:syntastic_python_flake8_args = "--max-line-length=119"

let g:syntastic_cpp_compiler = 'g++'
let g:syntastic_cpp_compiler_options = ' -std=c++11 -stdlib=libc++ -Wall'
let g:syntastic_cpp_check_header = 1
let g:syntastic_cpp_auto_refresh_includes = 1
let g:syntastic_always_populate_loc_list = 1
let g:syntastic_auto_loc_list = 1
let g:syntastic_check_on_open = 1
let g:syntastic_check_on_wq = 0
let g:syntastic_aggregate_errors = 1

"singlecompile shortcuts
nmap <F5> :SCCompile<cr>
nmap <F6> :SCCompileRun<cr>
" use g++ with C++11 support as default C++ compiler
call SingleCompile#SetCompilerTemplate('cpp', 'c++11', 'g++ with C++11 support',
                                      \'clang++', '-std=c++11 -stdlib=libc++ -Wall -o $(FILE_TITLE)$',
                                      \'echo -e "\n---\nOutput:\n" && ./$(FILE_TITLE)$')
call SingleCompile#SetOutfile('cpp', 'c++11', '$(FILE_TITLE)$')
call SingleCompile#ChooseCompiler('cpp', 'c++11')

" git diff
nmap <leader>g :GitGutterToggle
highlight SignColumn guibg=gray17
let g:gitgutter_realtime = 0
let g:gitgutter_eager = 0

" replace current line by the result of executing the command in a shell
nnoremap <Leader>x !!sh<cr>
